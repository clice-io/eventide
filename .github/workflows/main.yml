name: main

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      format: ${{ steps.filter.outputs.format }}
      cmake: ${{ steps.filter.outputs.cmake }}
      xmake: ${{ steps.filter.outputs.xmake }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            format:
              - '**/*.{h,c,cpp,hpp,cmake,lua,md,yml,yaml,toml}'
            cmake:
              - 'src/**'
              - 'include/**'
              - 'tests/**'
              - 'CMakeLists.txt'
              - 'pixi.toml'
              - '.github/workflows/main.yml'
              - '.github/workflows/cmake.yml'
            xmake:
              - 'src/**'
              - 'include/**'
              - 'tests/**'
              - 'xmake.lua'
              - 'pixi.toml'
              - '.github/workflows/main.yml'
              - '.github/workflows/xmake.yml'

  format:
    needs: changes
    if: ${{ needs.changes.outputs.format == 'true' }}
    permissions:
      contents: read
      checks: write
      issues: write
      pull-requests: write
    uses: ./.github/workflows/check-format.yml
    with:
      is_pull_request: ${{ github.event_name == 'pull_request' }}

  cmake:
    needs: changes
    if: ${{ needs.changes.outputs.cmake == 'true' }}
    uses: ./.github/workflows/cmake.yml

  xmake:
    needs: changes
    if: ${{ needs.changes.outputs.xmake == 'true' }}
    uses: ./.github/workflows/xmake.yml

  checks-passed:
    if: ${{ always() }}
    needs:
      - format
      - cmake
      - xmake
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        uses: re-actors/alls-green@release/v1
        with:
          allowed-skips: format,cmake,xmake
          jobs: ${{ toJSON(needs) }}
